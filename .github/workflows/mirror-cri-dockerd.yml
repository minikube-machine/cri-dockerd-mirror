name: Mirror upstream releases
on:
  schedule:
    - cron: '0 */8 * * *'
  workflow_dispatch:
permissions:
  contents: read
jobs:
  discover:
    runs-on: ubuntu-latest
    outputs:
      tags: ${{ steps.tags.outputs.tags }}
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
      - name: Find missing tags
        id: tags
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          tags=$(./missing-tags.sh ${{ github.repository }} Mirantis/cri-dockerd)
          echo "tags=$tags" >> $GITHUB_OUTPUT
  release:
    needs: discover
    if: needs.discover.outputs.tags != '[]'
    strategy:
      fail-fast: false
      max-parallel: 2 # Limit parallelism to avoid hitting API limits or overwhelming
      matrix:
        tag: ${{ fromJson(needs.discover.outputs.tags) }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout self source
        uses: actions/checkout@v4
      - name: Checkout upstream source
        uses: actions/checkout@v4
        with:
          repository: Mirantis/cri-dockerd
          ref: ${{ matrix.tag }}
          path: upstream
          fetch-depth: 1
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: upstream/go.mod
      - name: Build
        working-directory: upstream
        run: |
          version="${{ matrix.tag }}"
          commit=$(git rev-parse HEAD)
          short_commit=${commit:0:7}

          # Architectures to build
          archs=("amd64" "arm64" "arm" "s390x" "ppc64le")

          mkdir -p build

          for arch in "${archs[@]}"; do
            echo "Building for linux/$arch..."
            env GOOS=linux GOARCH=$arch CGO_ENABLED=0 go build \
              -ldflags "-X github.com/Mirantis/cri-dockerd/version.Version=${version} -X github.com/Mirantis/cri-dockerd/version.GitCommit=${short_commit}" \
              -o build/cri-dockerd-${version}.${arch}
          done

          # Copy systemd files
          cp packaging/systemd/cri-docker.service build/
          cp packaging/systemd/cri-docker.socket build/

      - name: Create release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          tag="${{ matrix.tag }}"
          # Create the release
          gh release create "$tag" -t "$tag" -n "Mirror of upstream release $tag"

          # Upload assets
          # The pattern matches all built binaries and systemd files
          gh release upload "$tag" upstream/build/*
